<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/scroller/2.0.3/css/scroller.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap4.min.css">

<script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/scroller/2.0.3/js/dataTables.scroller.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/plug-ins/1.10.25/features/pageResize/dataTables.pageResize.min.js"></script>
<script type="text/javascript" src="https://cdn.plot.ly/plotly-1.42.5.min.js"></script>


<div id="plots_div">
<table id="plots_grid"  class='row-border nowrap noHover pageResize' width="100%">
  <thead>
    <tr>
      <th></th>
      <th></th>
    </tr>
  </thead>
</table>
</div>



<script>
  jQuery.fn.dataTable.ext.type.search.hiddenVal = function(data) {
    return $('<div>').append(data).find('.hidden-val').text()
  }
  var gridview = 1;

  $(document).ready( function () {
  // data passed in as an array with plot title, coordinates and coverage values
  var data = [ '<div class="sub_plot">TP53 (NM.12345),sample0<br>sample1,sample1<br>sample2,sample2<br>sample3,sample3<br>sample4,sample4<br>sample5,sample5<br>sample6,sample6<br>sample7,sample7<br>sample8,sample8<br>sample9,sample9<br>sample10,sample10<br>sample11,sample11<br>sample12,sample12<br>sample13,sample13<br>sample14,sample14<br>sample15,sample15<br>sample16,sample16<br>sample17,sample17<br>sample18,sample18<br>sample19,sample19<br>sample20,sample20<br>sample21,sample21<br>sample22,sample22<br>sample23,sample23<br>sample24,sample24<br>sample25,sample25<br>sample26,sample26<br>sample27,sample27<br>sample28,sample28<br>sample29,sample29<br>sample30,sample30<br>sample31,sample31<br>sample32,sample32<br>sample33,sample33<br>sample34,sample34<br>sample35,sample35<br>sample36,sample36<br>sample37,sample37<br>sample38,sample38<br>sample39,sample39<br>sample40,sample40<br>sample41,sample41<br>sample42,sample42<br>sample43,sample43<br>sample44,sample44<br>sample45,sample45<br>sample46,sample46<br>sample47,sample47<br>sample48,sample48<br>sample49,sample49<br>sample50,sample50<br>sample51,sample51<br>sample52,sample52<br>sample53,sample53<br>sample54,sample54<br>sample55,sample55<br>sample56,sample56<br>sample57,sample57<br>sample58,sample58<br>sample59,49, 61, 105, 111, 45, 131, 187, 78, 66, 160, 128, 36, 46, 122, 65, 64, 123, 113, 74, 157, 59, 98, 53, 14, 73, 164, 183, 188, 173, 109, 40, 174, 38, 130, 84, 194, 83, 153, 55, 52, 28, 195, 58, 139, 175, 57, 136, 85, 162, 79, 5, 8, 9, 4, 7, 3, 6, 10, 0.1, 0.1, 0.12, 0.15, 0.19, 0.15, 0.07, 0.08, 0.11, 0.18, 0.09, 0.11, 0.17, 0.07, 0.03, 0.17, 0.06, 0.13, 0.05, 0.1, 0.16, 0.12, 0.19, 0.09, 0.08, 0.15, 0.07, 0.06, 0.04, 0.14, 0.17, 0.1, 0.09, 0.03, 0.11, 0.16, 0.1, 0.07, 0.14, 0.06, 0.2, 0.17, 0.07, 0.08, 0.08, 0.09, 0.07, 0.08, 0.17, 0.08, 0.84, 0.86, 0.88, 0.85, 0.89, 0.92, 0.88, 0.84, 0.88, 0.86</div>'
  ];

  // plotly layout properties
  let layout = {
    hovermode:'closest',
    title: "",
    showlegend: false,
    plot_bgcolor: '#f7fbfd',
    shapes: [{
      // threshold line
      type: 'line',
      xref: 'paper',
      x0: 0,
      y0: '',
      x1: 1,
      y1: '',
      line:{
        color: 'rgb(255, 0, 0)',
        width: 1
      }
  }],
    xaxis: {
      showgrid: false,
      showline: false,
      showticklabels: true,
    },
    yaxis: {
      title: "count",
      rangemode: "tozero",
      tickmode: "array",
      tickvals: ""
      }
  };

  // config for plotly to pass data to
  let dataConfig = [{
    type: "scatter",
    mode: "markers",
    x: [],
    y: [],
    text:'text',
    hoverinfo: 'text',
    marker: {
      size: 5
    }
  }];

  var table = $('#plots_grid').DataTable({
    data: data,
    deferRender:    true,
    scrollY:        "70vh",
    scrollX:        true,
    "searching":    true,
    "lengthMenu":   [[15, 30, 60, -1], [15, 30, 60, "All"]],
    'processing':   true,
    'language': {
      'processing': 'Loading...'
    },
    "columnDefs": [
      {
        "targets": [ 0 ],
        "visible": false,
        "searchable": true
      },
      {
        "targets": [ 1 ],
        "visible": false,
        "searchable": true
      },
    ],

    "preDrawCallback": function (oSettings) {
      // function to create responsive container over dataTable for adding plots to
      if(gridview == 1) {
        // create an empty plot container, put it in the dataTables_scrollBody div
        if ($('#plot_container').length < 1) { 
          $('.dataTables_scrollBody').append('<div id="plot_container"></div>'); 
        } 
        $('#plot_container').html('');

        return true;
      }
    },

    "rowCallback": function( nRow, data, iDisplayIndex, iDisplayIndexFull ) {
      // function to add data from array into container
      if(gridview == 1) {  
        $('#plot_container').append(data);
      }
      return nRow
    },

    "drawCallback": function (oSettings, data) {
      // function to generate plots on every search / refresh
      $('.sub_plot').each(function(data) {
        let div = $(this)[0];

        // given array has title, coordinates and coverage values, split in half to seperate
        let array = [div.innerHTML][0].split(",")

        var samples = array.splice(1, Math.floor(array.length / 3))
        var coords = array.splice(1, Math.floor(array.length / 2));
        var cov = array.splice(2);
        var title = array[0];

        // random colour for plot line
        var hue = Math.floor(Math.random() *  358) + 1
        var color = "hsl( " + hue + ", 60%, 50% )"

        // build text for hover labels on data points
        var text = [];
        coords.forEach((coord, index) => {
          const cov_val = cov[index];
          const label = samples[index]
          var coord = String(coord).replace(/\B(?=(\d{3})+(?!\d))/g, ","); // adds ',' seperator at 1000s
          text.push("count: " + coord + "<br>VAF: " + cov_val + "<br><br>Samples:<br>" + label
          );
        });

        // value for threshold line
        var threshold = '$threshold';
        threshold = parseInt(threshold.slice(0, -1)); // remove x from end

/*         // calculate max coordinate value and intervals for y-axis ticks from coverage values
        // generates an array of 6 numbers evenly space between 0 -> max coverage value
        var max = Math.max(...cov)
        if ( max < threshold ) { max = threshold } // set max to threshold if lower

        // scale values appropriately for > & < 1000 and set step value
        if (max > 1000) {
          max = Math.ceil(max / 100) * 100
          var step = Math.ceil(Math.ceil(max / 5) / 100) * 100
          } else {
            max = Math.ceil(max / 10) * 10
            var step = Math.ceil(Math.ceil(max / 5) / 10 ) * 10
            } */

        // generate array of 6 values for y-axis ticks
        /* var intervals = Array(6).fill().map((_, idx) => 0 + (idx * step)) */

        // pass values to config and layout for plotly
        let t_dataConfig = dataConfig;
        t_dataConfig[0].x = cov;
        t_dataConfig[0].y = coords;
        /* t_dataConfig[0].line.color = color */;
        t_dataConfig[0].text = text;
        layout.shapes[0].y0 = threshold;
        layout.shapes[0].y1 = threshold;
        layout.title = title;
        /* layout.yaxis.tickvals = intervals */;

        while(div.firstChild) { div.removeChild(div.firstChild); }
        // call plotly to generate plot
        Plotly.react(
          div,
          t_dataConfig,
          layout,
          {
            displaylogo: false,
            modeBarButtonsToRemove: [
              'hoverClosestCartesian', 'hoverCompareCartesian', 'toggleSpikelines'
            ]
          }
        );
      });
    }
  });
  });
</script>